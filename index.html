<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Invoice CRM ‚Äî Yadav Gardening Services</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root{
      --brand: #2e7d32;
      --brand-light: #4caf50;
      --muted: #6b7280;
      --panel: #ffffff;
      --bg: #f4f6f8;
      --accent: #e6f4ea;
      --card-radius: 12px;
      --shadow: 0 2px 12px rgba(15,23,42,0.1);
      --shadow-hover: 0 4px 20px rgba(15,23,42,0.15);
      font-family: 'Segoe UI', Inter, ui-sans-serif, system-ui, -apple-system, Roboto, 'Helvetica Neue', Arial;
    }
    * { box-sizing: border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:#111827;
      padding:0;
      min-height:100vh;
    }
    .mobile-header {
      display:none;
      background:var(--brand);
      color:white;
      padding:16px 20px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      position:sticky;
      top:0;
      z-index:100;
    }
    .mobile-header h1 {
      margin:0;
      font-size:18px;
      font-weight:700;
    }
    .mobile-header p {
      margin:4px 0 0 0;
      font-size:12px;
      opacity:0.9;
    }
    .container{
      width:100%;
      max-width:1600px;
      margin:0 auto;
      padding:24px;
      display:grid;
      grid-template-columns: 380px 380px 1fr;
      gap:20px;
    }
    .panel{
      background:var(--panel);
      border-radius:var(--card-radius);
      padding:24px;
      box-shadow:var(--shadow);
      overflow:auto;
      max-height:90vh;
      transition:box-shadow 0.3s;
    }
    .panel:hover {
      box-shadow:var(--shadow-hover);
    }
    .panel h2 { 
      margin:0 0 20px 0; 
      font-size:17px; 
      color:var(--brand); 
      font-weight:700;
      padding-bottom:14px;
      border-bottom:2px solid var(--accent);
      display:flex;
      align-items:center;
      gap:8px;
    }
    label { 
      display:block; 
      font-size:13px; 
      font-weight:600;
      color:#374151; 
      margin-top:16px;
      margin-bottom:6px;
    }
    input[type="text"], input[type="date"], input[type="number"], input[type="file"], select, textarea {
      width:100%;
      padding:10px 14px;
      margin-top:2px;
      border-radius:8px;
      border:1px solid #e5e7eb;
      font-size:14px;
      background:#fff;
      transition: all 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      outline:none;
      border-color:var(--brand);
      box-shadow:0 0 0 3px rgba(46,125,50,0.1);
    }
    .logo-upload {
      margin-top:16px;
      padding:20px;
      background:var(--accent);
      border-radius:10px;
      text-align:center;
    }
    .logo-preview {
      width:100px;
      height:100px;
      margin:16px auto;
      border-radius:10px;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      border:3px solid var(--brand);
      box-shadow:0 4px 12px rgba(46,125,50,0.15);
    }
    .logo-preview img {
      max-width:100%;
      max-height:100%;
      object-fit:contain;
    }
    .logo-preview .placeholder {
      font-size:28px;
      font-weight:800;
      color:var(--brand);
    }
    .items-section {
      background:var(--panel);
      border-radius:var(--card-radius);
      padding:24px;
      box-shadow:var(--shadow);
      grid-column: 1 / -1;
    }
    .items-section h2 {
      margin:0 0 20px 0; 
      font-size:17px; 
      color:var(--brand); 
      font-weight:700;
      padding-bottom:14px;
      border-bottom:2px solid var(--accent);
    }
    .items-header {
      display:flex; 
      justify-content:space-between; 
      align-items:center;
      margin-bottom:20px;
      flex-wrap:wrap;
      gap:12px;
    }
    .item-row { 
      display:grid; 
      grid-template-columns: 40px 1fr 120px 90px 120px 50px; 
      gap:12px; 
      align-items:center; 
      margin-bottom:12px;
      padding:14px;
      background:#f9fafb;
      border-radius:10px;
      transition:all 0.2s;
    }
    .item-row:hover {
      background:#f3f4f6;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }
    .item-row input { 
      padding:10px 12px; 
      font-size:14px; 
      border-radius:8px; 
      border:1px solid #e5e7eb; 
    }
    .item-number {
      font-weight:700;
      color:var(--muted);
      text-align:center;
      font-size:15px;
    }
    .btn {
      background:var(--brand); 
      color:white; 
      border:none; 
      padding:11px 20px; 
      border-radius:8px; 
      cursor:pointer;
      font-size:14px;
      font-weight:600;
      transition: all 0.2s;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .btn:hover {
      background:#1b5e20;
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(46,125,50,0.3);
    }
    .btn:active {
      transform:translateY(0);
    }
    .btn.ghost { 
      background:transparent; 
      color:var(--brand); 
      border:2px solid var(--accent); 
    }
    .btn.ghost:hover {
      background:var(--accent);
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(46,125,50,0.15);
    }
    .btn.small { 
      padding:8px 14px; 
      font-size:13px; 
    }
    .btn.danger {
      background:#dc2626;
    }
    .btn.danger:hover {
      background:#b91c1c;
    }
    .actions { 
      display:flex; 
      gap:10px; 
      margin-top:20px; 
      flex-wrap:wrap; 
    }
    .invoice-details {
      background:var(--panel);
      border-radius:var(--card-radius);
      padding:24px;
      box-shadow:var(--shadow);
      grid-column: 1 / -1;
    }
    .invoice-details h2 {
      margin:0 0 20px 0; 
      font-size:17px; 
      color:var(--brand); 
      font-weight:700;
      padding-bottom:14px;
      border-bottom:2px solid var(--accent);
    }
    .invoice-grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:20px;
    }
    .preview {
      background:#fff;
      border-radius:var(--card-radius);
      padding:40px;
      box-shadow:var(--shadow);
      min-height: 90vh;
      overflow:auto;
      grid-column: 3;
      grid-row: 1 / span 10;
    }
    .invoice {
      max-width:800px;
      margin:0 auto;
      color:#111827;
    }
    .inv-header {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:24px;
      flex-wrap:wrap;
    }
    .brand {
      display:flex; 
      gap:16px; 
      align-items:center;
      flex:1;
      min-width:250px;
    }
    .logo {
      width:80px; 
      height:80px; 
      background:var(--brand); 
      border-radius:10px; 
      color:white;
      display:flex; 
      align-items:center; 
      justify-content:center; 
      font-weight:800; 
      font-size:22px;
      overflow:hidden;
      flex-shrink:0;
      box-shadow:0 4px 12px rgba(46,125,50,0.2);
    }
    .logo img {
      width:100%;
      height:100%;
      object-fit:contain;
    }
    .brand h1 { 
      margin:0; 
      font-size:22px; 
      color:var(--brand); 
      line-height:1.3;
    }
    .brand p { 
      margin:6px 0 0 0; 
      font-size:13px; 
      color:var(--muted); 
      line-height:1.5;
    }
    .meta {
      text-align:right;
      font-size:13px;
    }
    .meta .title { 
      font-size:20px; 
      color:var(--brand); 
      font-weight:700; 
      margin-bottom:8px; 
    }
    .qr-section {
      margin-top:12px;
      padding:12px;
      background:var(--accent);
      border-radius:8px;
      display:inline-block;
    }
    #invoiceQR {
      margin:8px auto 0;
      display:block;
    }
    hr.sep { 
      border:none; 
      border-top:2px solid #eef2f6; 
      margin:20px 0 24px; 
    }
    .addresses {
      display:flex; 
      gap:24px; 
      justify-content:space-between; 
      margin-bottom:20px;
      flex-wrap:wrap;
    }
    .addresses .box { 
      flex:1;
      min-width:200px;
    }
    .addresses h3 { 
      margin:0 0 10px 0; 
      color:var(--brand); 
      font-size:15px; 
      font-weight:700;
    }
    .addresses p { 
      margin:0; 
      color:var(--muted); 
      font-size:14px; 
      line-height:1.7; 
    }
    table.items-table {
      width:100%;
      border-collapse:collapse;
      font-size:14px;
      margin-top:20px;
    }
    table.items-table thead th {
      text-align:left; 
      padding:12px 10px; 
      background:#fbfffb; 
      color:var(--muted); 
      border-bottom:2px solid #eef2f6;
      font-weight:700;
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    table.items-table td { 
      padding:14px 10px; 
      border-bottom:1px solid #f3f5f7; 
      vertical-align:top; 
    }
    table.items-table tfoot td { 
      padding:12px 10px; 
      border-top:2px solid #eef2f6; 
      font-weight:700; 
      font-size:15px;
    }
    .right { text-align:right; }
    .muted { color:var(--muted); font-size:14px; }
    .signature {
      display:flex; 
      justify-content:flex-end; 
      margin-top:32px;
    }
    .signature .block { 
      text-align:right; 
      font-size:14px; 
      color:var(--muted); 
    }
    .notes { 
      margin-top:24px; 
      color:var(--muted); 
      font-size:14px; 
      border-top:2px dashed #e6edf0; 
      padding-top:16px; 
      line-height:1.6;
    }
    .info-box {
      margin-top:20px;
      padding:16px;
      background:var(--accent);
      border-radius:10px;
      font-size:12px;
      color:var(--muted);
      border-left:4px solid var(--brand);
    }
    .info-box strong {
      color:var(--brand);
    }
    .json-import {
      margin-top:16px;
      padding:16px;
      background:#fff3cd;
      border-radius:10px;
      border-left:4px solid #ffc107;
    }
    .json-import label {
      margin:0 0 8px 0;
      color:#856404;
      font-weight:700;
    }
    
    /* Mobile Responsive */
    @media (max-width:1400px){
      .container{ 
        grid-template-columns: 1fr 1fr; 
        padding:16px;
      }
      .preview {
        grid-column: 1 / -1;
        grid-row: auto;
        padding:24px;
      }
      .items-section, .invoice-details {
        grid-column: 1 / -1;
      }
    }
    
    @media (max-width:768px){
      body { padding:0; }
      .mobile-header { display:block; }
      .container { 
        grid-template-columns: 1fr;
        padding:12px;
        gap:16px;
      }
      .panel {
        padding:16px;
        max-height:none;
      }
      .panel h2 {
        font-size:16px;
        margin-bottom:16px;
        padding-bottom:12px;
      }
      .preview {
        padding:16px;
        min-height:auto;
      }
      .invoice {
        font-size:13px;
      }
      .inv-header {
        flex-direction:column;
        gap:16px;
      }
      .brand {
        min-width:auto;
      }
      .logo {
        width:60px;
        height:60px;
        font-size:18px;
      }
      .brand h1 {
        font-size:18px;
      }
      .brand p {
        font-size:12px;
      }
      .meta {
        text-align:left;
        width:100%;
      }
      .meta .title {
        font-size:18px;
      }
      .addresses {
        flex-direction:column;
        gap:16px;
      }
      .addresses .box {
        width:100%;
      }
      .item-row {
        grid-template-columns: 30px 1fr 80px 60px 90px 40px;
        gap:6px;
        padding:10px;
      }
      .item-row input {
        padding:8px 6px;
        font-size:13px;
      }
      .invoice-grid {
        grid-template-columns: 1fr;
      }
      .actions {
        flex-direction:column;
      }
      .actions .btn {
        width:100%;
        justify-content:center;
      }
      .items-header {
        flex-direction:column;
        align-items:stretch;
      }
      .items-header > div {
        width:100%;
      }
      .items-header .btn {
        width:100%;
      }
      table.items-table {
        font-size:12px;
      }
      table.items-table thead th {
        padding:8px 6px;
        font-size:11px;
      }
      table.items-table td {
        padding:10px 6px;
      }
      .qr-section {
        padding:8px;
      }
      #invoiceQR canvas {
        max-width:100px !important;
        height:auto !important;
      }
    }
    
    @media (max-width:480px){
      .item-row {
        grid-template-columns: 1fr;
        gap:8px;
      }
      .item-number {
        text-align:left;
      }
      .logo-preview {
        width:80px;
        height:80px;
      }
    }
  </style>
</head>
<body>
  <div class="mobile-header">
    <h1>üåø Invoice CRM</h1>
    <p>Yadav Gardening Services</p>
  </div>
  
  <div class="container">
    <!-- Supplier Panel -->
    <div class="panel">
      <h2>üì¶ Supplier / Your Company</h2>
      <div class="logo-upload">
        <label style="margin:0; font-size:12px; color:var(--muted)">Company Logo</label>
        <div class="logo-preview" id="supplierLogoPreview">
          <div class="placeholder">YGS</div>
        </div>
        <input type="file" id="logoUpload" accept="image/*" style="font-size:12px" />
        <button class="btn ghost small" id="clearLogoBtn" style="margin-top:10px">Clear Logo</button>
      </div>
      <label>Business Name</label>
      <input id="supplier_name" type="text" placeholder="Yadav Gardening Services" />
      
      <label>Address</label>
      <textarea id="supplier_address" rows="3" placeholder="Full business address"></textarea>
      
      <label>Phone</label>
      <input id="supplier_phone" type="text" placeholder="+91 9560458350" />
      
      <label>Email</label>
      <input id="supplier_email" type="text" placeholder="contact@business.com" />
      
      <label>Website (for QR code)</label>
      <input id="supplier_website" type="text" placeholder="https://yourwebsite.com" />
      
      <label>Authorized Signatory</label>
      <input id="supplier_signatory" type="text" placeholder="Sachin Yadav" />
      
      <div class="actions">
        <button class="btn" id="saveSupplierBtn">üíæ Save Supplier</button>
        <button class="btn ghost" id="clearSupplierBtn">üóëÔ∏è Clear</button>
      </div>
    </div>
    
    <!-- Client Panel -->
    <div class="panel">
      <h2>üë§ Client / Bill To</h2>
      <label>Client Name</label>
      <input id="client_name" type="text" placeholder="Client or Company name" />
      
      <label>Address</label>
      <textarea id="client_address" rows="3" placeholder="Client address"></textarea>
      
      <label>Phone</label>
      <input id="client_phone" type="text" placeholder="Client phone" />
      
      <label>Email</label>
      <input id="client_email" type="text" placeholder="client@email.com" />
      
      <div class="actions">
        <button class="btn" id="saveClientBtn">üíæ Save Client</button>
        <button class="btn ghost" id="loadClientBtn">üìÇ Load Client</button>
      </div>
      
      <div class="json-import">
        <label>üì• Import from JSON</label>
        <input type="file" id="jsonImport" accept=".json" style="font-size:12px; background:#fff" />
        <p style="margin:8px 0 0 0; font-size:11px; color:#856404">Upload a JSON file to auto-fill invoice data</p>
      </div>
      
      <div class="info-box">
        üí° <strong>Tip:</strong> Save frequently used clients for quick access. JSON import supports full invoice data.
      </div>
    </div>
    
    <!-- Preview -->
    <div class="preview">
      <div id="invoicePreview" class="invoice">
        <div class="inv-header">
          <div class="brand">
            <div class="logo" id="invoiceLogoDisplay">
              <div id="invoiceLogoPlaceholder">YGS</div>
            </div>
            <div>
              <h1 id="supplierName">Yadav Gardening Services</h1>
              <p id="supplierAddress">Plot No-433, RZ-Q-4, IMT, Manesar, Gurugram, Haryana</p>
              <p id="supplierContact" style="margin-top:6px; font-size:13px; color:var(--muted)"></p>
            </div>
          </div>
          <div class="meta">
            <div class="title">TAX INVOICE</div>
            <div class="muted">Invoice #: <strong id="previewInvoiceNo">#INV-001</strong></div>
            <div class="muted">Date: <strong id="previewDate">29 Oct 2025</strong></div>
            <div style="height:8px"></div>
            <div class="muted">Status: <strong id="previewStatus">DRAFT</strong></div>
            <div class="qr-section">
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px; font-weight:600">Scan for Details</div>
              <div id="invoiceQR"></div>
            </div>
          </div>
        </div>
        <hr class="sep" />
        <div class="addresses">
          <div class="box">
            <h3>Bill To:</h3>
            <p id="billTo">Client Name</p>
          </div>
          <div class="box">
            <h3>Supplier:</h3>
            <p id="supplierDetails">Yadav Gardening Services<br>Gurugram, Haryana<br>+91 9560458350<br>ygs@live.com</p>
          </div>
        </div>
        <table class="items-table" id="previewItemsTable">
          <thead>
            <tr>
              <th style="width:40px">#</th>
              <th>Description</th>
              <th style="width:120px">Rate</th>
              <th style="width:90px">Qty</th>
              <th style="width:130px" class="right">Amount</th>
            </tr>
          </thead>
          <tbody id="previewItemsBody"></tbody>
          <tfoot>
            <tr>
              <td colspan="4" class="right muted">Subtotal:</td>
              <td class="right" id="previewSubtotal">‚Çπ0.00</td>
            </tr>
            <tr>
              <td colspan="4" class="right muted" style="font-size:16px">Total:</td>
              <td class="right" id="previewTotal" style="font-size:16px; color:var(--brand)">‚Çπ0.00</td>
            </tr>
          </tfoot>
        </table>
        <div class="signature">
          <div class="block">
            <div>For <span id="signCompany">Yadav Gardening Services</span></div>
            <div style="font-weight:700; margin-top:10px;" id="signName">Sachin Yadav</div>
            <div style="font-size:13px; margin-top:6px;">Authorized Signatory</div>
          </div>
        </div>
        <div class="notes" id="previewNotes">
          <strong>Notes:</strong>
          <div id="previewNotesText">Thank you for choosing Yadav Gardening Services.</div>
        </div>
      </div>
    </div>
    
    <!-- Invoice Details -->
    <div class="invoice-details">
      <h2>üìÑ Invoice Details</h2>
      <div class="invoice-grid">
        <div>
          <label>Invoice Number</label>
          <input id="invoice_number" type="text" placeholder="INV-0001" />
        </div>
        <div>
          <label>Company ID (optional)</label>
          <input id="company_id" type="text" placeholder="C001" />
        </div>
        <div>
          <label>Date</label>
          <input id="created_at" type="date" />
        </div>
        <div>
          <label>Status</label>
          <select id="status">
            <option value="draft">Draft</option>
            <option value="sent">Sent</option>
            <option value="paid">Paid</option>
            <option value="overdue">Overdue</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- Items Section -->
    <div class="items-section">
      <div class="items-header">
        <h2 style="margin:0; border:none; padding:0;">üìù Invoice Items</h2>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn small" id="addItemBtn">+ Add Item</button>
          <button class="btn ghost small" id="clearItemsBtn">Clear All</button>
        </div>
      </div>
      <div id="itemsBody"></div>
    </div>
    
    <!-- Actions Section -->
    <div class="invoice-details">
      <h2>‚ö° Actions</h2>
      
      <label>Notes (appears at bottom of invoice)</label>
      <textarea id="notes" rows="3">Thank you for choosing Yadav Gardening Services.</textarea>
      
      <div class="actions" style="margin-top:20px">
        <button class="btn" id="previewBtn">üëÅÔ∏è Update Preview</button>
        <button class="btn" id="saveBtn">üíæ Save Invoice</button>
        <button class="btn ghost" id="loadBtn">üìÇ Load Saved</button>
      </div>
      
      <div style="margin-top:16px; padding-top:16px; border-top:2px solid #e5e7eb">
        <label>Export Options</label>
        <div class="actions" style="margin-top:12px">
          <button class="btn" id="pdfBtn">üìÑ Generate PDF</button>
          <button class="btn ghost" id="downloadJsonBtn">üì• Download JSON</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // DOM references
    const supplierNameInput = document.getElementById('supplier_name');
    const supplierAddressInput = document.getElementById('supplier_address');
    const supplierPhoneInput = document.getElementById('supplier_phone');
    const supplierEmailInput = document.getElementById('supplier_email');
    const supplierWebsiteInput = document.getElementById('supplier_website');
    const supplierSignInput = document.getElementById('supplier_signatory');
    const saveSupplierBtn = document.getElementById('saveSupplierBtn');
    const clearSupplierBtn = document.getElementById('clearSupplierBtn');
    const logoUpload = document.getElementById('logoUpload');
    const supplierLogoPreview = document.getElementById('supplierLogoPreview');
    const clearLogoBtn = document.getElementById('clearLogoBtn');
    const invoiceLogoDisplay = document.getElementById('invoiceLogoDisplay');
    const clientNameInput = document.getElementById('client_name');
    const clientAddressInput = document.getElementById('client_address');
    const clientPhoneInput = document.getElementById('client_phone');
    const clientEmailInput = document.getElementById('client_email');
    const saveClientBtn = document.getElementById('saveClientBtn');
    const loadClientBtn = document.getElementById('loadClientBtn');
    const jsonImport = document.getElementById('jsonImport');
    const invoiceNoInput = document.getElementById('invoice_number');
    const companyIdInput = document.getElementById('company_id');
    const createdAtInput = document.getElementById('created_at');
    const statusInput = document.getElementById('status');
    const itemsBody = document.getElementById('itemsBody');
    const addItemBtn = document.getElementById('addItemBtn');
    const clearItemsBtn = document.getElementById('clearItemsBtn');
    const previewInvoiceNo = document.getElementById('previewInvoiceNo');
    const previewDate = document.getElementById('previewDate');
    const previewStatus = document.getElementById('previewStatus');
    const supplierNameEl = document.getElementById('supplierName');
    const supplierAddressEl = document.getElementById('supplierAddress');
    const supplierContactEl = document.getElementById('supplierContact');
    const supplierDetailsEl = document.getElementById('supplierDetails');
    const billToEl = document.getElementById('billTo');
    const previewItemsBody = document.getElementById('previewItemsBody');
    const previewSubtotal = document.getElementById('previewSubtotal');
    const previewTotal = document.getElementById('previewTotal');
    const previewNotesText = document.getElementById('previewNotesText');
    const notesInput = document.getElementById('notes');
    const signCompanyEl = document.getElementById('signCompany');
    const signNameEl = document.getElementById('signName');
    const saveBtn = document.getElementById('saveBtn');
    const loadBtn = document.getElementById('loadBtn');
    const pdfBtn = document.getElementById('pdfBtn');
    const previewBtn = document.getElementById('previewBtn');
    const downloadJsonBtn = document.getElementById('downloadJsonBtn');
    
    // Storage keys
    const SUPPLIER_KEY = 'invoice_supplier_v3';
    const CLIENT_KEY = 'invoice_client_v3';
    const INVOICE_KEY = 'invoice_saved_v3';
    
    let currentLogoData = null;
    let qrCodeInstance = null;
    
    // Initialize
    createdAtInput.value = new Date().toISOString().substr(0,10);
    invoiceNoInput.value = 'INV-00125';
    
    // Logo handling
    logoUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          currentLogoData = event.target.result;
          displayLogo(currentLogoData);
          const supplierData = getSupplierData();
          supplierData.logo = currentLogoData;
          localStorage.setItem(SUPPLIER_KEY, JSON.stringify(supplierData));
        };
        reader.readAsDataURL(file);
      }
    });
    
    clearLogoBtn.addEventListener('click', () => {
      currentLogoData = null;
      displayLogo(null);
      logoUpload.value = '';
      const supplierData = getSupplierData();
      delete supplierData.logo;
      localStorage.setItem(SUPPLIER_KEY, JSON.stringify(supplierData));
    });
    
    function displayLogo(logoData) {
      if (logoData) {
        supplierLogoPreview.innerHTML = `<img src="${logoData}" alt="Logo" />`;
        invoiceLogoDisplay.innerHTML = `<img src="${logoData}" alt="Logo" />`;
      } else {
        supplierLogoPreview.innerHTML = '<div class="placeholder">YGS</div>';
        invoiceLogoDisplay.innerHTML = '<div id="invoiceLogoPlaceholder">YGS</div>';
      }
    }
    
    // QR Code generation
    function generateQRCode() {
      const qrContainer = document.getElementById('invoiceQR');
      qrContainer.innerHTML = '';
      
      const supplier = getSupplierData();
      const qrData = {
        company: supplier.name || 'Yadav Gardening Services',
        phone: supplier.phone || '',
        email: supplier.email || '',
        website: supplier.website || '',
        address: supplier.address || ''
      };
      
      let qrText = supplier.website || '';
      if (!qrText) {
        qrText = `Company: ${qrData.company}\nPhone: ${qrData.phone}\nEmail: ${qrData.email}\nAddress: ${qrData.address}`;
      }
      
      try {
        new QRCode(qrContainer, {
          text: qrText,
          width: 120,
          height: 120,
          colorDark: "#2e7d32",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.M
        });
      } catch (e) {
        console.error('QR Code generation failed:', e);
      }
    }
    
    // Get supplier data
    function getSupplierData() {
      return {
        name: supplierNameInput.value.trim(),
        address: supplierAddressInput.value.trim(),
        phone: supplierPhoneInput.value.trim(),
        email: supplierEmailInput.value.trim(),
        website: supplierWebsiteInput.value.trim(),
        signatory: supplierSignInput.value.trim(),
        logo: currentLogoData
      };
    }
    
    // Load supplier
    function loadSupplier() {
      const raw = localStorage.getItem(SUPPLIER_KEY);
      if (!raw) {
        supplierNameInput.value = 'Yadav Gardening Services';
        supplierAddressInput.value = 'Plot No-433, RZ-Q-4, IMT, Manesar, Gurugram, Haryana';
        supplierPhoneInput.value = '+91 9560458350';
        supplierEmailInput.value = 'ygs@live.com';
        supplierWebsiteInput.value = 'https://yadavgardening.com';
        supplierSignInput.value = 'Sachin Yadav';
        return;
      }
      try {
        const s = JSON.parse(raw);
        supplierNameInput.value = s.name || '';
        supplierAddressInput.value = s.address || '';
        supplierPhoneInput.value = s.phone || '';
        supplierEmailInput.value = s.email || '';
        supplierWebsiteInput.value = s.website || '';
        supplierSignInput.value = s.signatory || '';
        currentLogoData = s.logo || null;
        displayLogo(currentLogoData);
      } catch (e) {
        console.warn('Invalid supplier data');
      }
    }
    
    // Save supplier
    function saveSupplier() {
      const s = getSupplierData();
      localStorage.setItem(SUPPLIER_KEY, JSON.stringify(s));
      alert('‚úÖ Supplier information saved successfully!');
      updatePreview();
    }
    
    // Clear supplier
    function clearSupplier() {
      if (confirm('Clear all supplier information?')) {
        localStorage.removeItem(SUPPLIER_KEY);
        currentLogoData = null;
        loadSupplier();
        updatePreview();
      }
    }
    
    saveSupplierBtn.addEventListener('click', saveSupplier);
    clearSupplierBtn.addEventListener('click', clearSupplier);
    
    // Client functions
    function saveClient() {
      const client = {
        name: clientNameInput.value.trim(),
        address: clientAddressInput.value.trim(),
        phone: clientPhoneInput.value.trim(),
        email: clientEmailInput.value.trim()
      };
      localStorage.setItem(CLIENT_KEY, JSON.stringify(client));
      alert('‚úÖ Client information saved successfully!');
      updatePreview();
    }
    
    function loadClient() {
      const raw = localStorage.getItem(CLIENT_KEY);
      if (!raw) {
        alert('‚ùå No saved client found');
        return;
      }
      try {
        const client = JSON.parse(raw);
        clientNameInput.value = client.name || '';
        clientAddressInput.value = client.address || '';
        clientPhoneInput.value = client.phone || '';
        clientEmailInput.value = client.email || '';
        updatePreview();
        alert('‚úÖ Client information loaded!');
      } catch (e) {
        alert('‚ùå Error loading client data');
      }
    }
    
    saveClientBtn.addEventListener('click', saveClient);
    loadClientBtn.addEventListener('click', loadClient);
    
    // JSON Import
    jsonImport.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            importFromJSON(data);
            alert('‚úÖ Invoice data imported successfully!');
          } catch (error) {
            alert('‚ùå Invalid JSON file. Please check the format.');
            console.error('JSON import error:', error);
          }
        };
        reader.readAsText(file);
      }
    });
    
    function importFromJSON(data) {
      // Import supplier info
      if (data.companies || data.company_name) {
        supplierNameInput.value = data.companies?.name || data.company_name || '';
        supplierAddressInput.value = data.company_address || '';
        supplierPhoneInput.value = data.company_phone || '';
        supplierEmailInput.value = data.company_email || '';
        supplierWebsiteInput.value = data.company_website || '';
        supplierSignInput.value = data.signatory || '';
        if (data.logo) {
          currentLogoData = data.logo;
          displayLogo(currentLogoData);
        }
      }
      
      // Import client info
      if (data.client) {
        clientNameInput.value = data.client.name || '';
        clientAddressInput.value = data.client.address || '';
        clientPhoneInput.value = data.client.phone || '';
        clientEmailInput.value = data.client.email || '';
      }
      
      // Import invoice details
      if (data.invoice_number) invoiceNoInput.value = data.invoice_number;
      if (data.company_id) companyIdInput.value = data.company_id;
      if (data.created_at) {
        const date = new Date(data.created_at);
        createdAtInput.value = date.toISOString().substr(0,10);
      }
      if (data.status) statusInput.value = data.status;
      if (data.notes) notesInput.value = data.notes;
      
      // Import items
      if (data.items && Array.isArray(data.items)) {
        itemsBody.innerHTML = '';
        data.items.forEach(item => {
          createItemRow({
            description: item.description || '',
            quantity: item.quantity || 1,
            rate: item.rate || 0
          });
        });
      }
      
      updatePreview();
    }
    
    // Item functions
    function createItemRow(item = { description:'', quantity:1, rate:0 }) {
      const idx = itemsBody.children.length;
      const row = document.createElement('div');
      row.className = 'item-row';
      row.dataset.index = idx;
      row.innerHTML = `
        <div class="item-number">${idx+1}</div>
        <input class="desc" placeholder="Item description" value="${escapeHtml(item.description)}" />
        <input class="rate" placeholder="Rate" type="number" value="${item.rate}" step="0.01" />
        <input class="qty" placeholder="Qty" type="number" value="${item.quantity}" step="1" />
        <input class="amount" placeholder="Amount" type="text" value="${(item.rate*item.quantity).toFixed(2)}" readonly style="background:#f3f4f6" />
        <button class="btn danger small remove">‚úï</button>
      `;
      
      const desc = row.querySelector('.desc');
      const rate = row.querySelector('.rate');
      const qty = row.querySelector('.qty');
      const amt = row.querySelector('.amount');
      const rm = row.querySelector('.remove');
      
      function recalc() {
        const r = parseFloat(rate.value || 0);
        const q = parseFloat(qty.value || 0) || 0;
        amt.value = (r * q).toFixed(2);
        updatePreview();
      }
      
      rate.addEventListener('input', recalc);
      qty.addEventListener('input', recalc);
      desc.addEventListener('input', updatePreview);
      
      rm.addEventListener('click', () => {
        row.remove();
        reindexItems();
        updatePreview();
      });
      
      itemsBody.appendChild(row);
      return row;
    }
    
    function reindexItems() {
      Array.from(itemsBody.children).forEach((r, i) => {
        r.dataset.index = i;
        r.querySelector('.item-number').textContent = i+1;
      });
    }
    
    addItemBtn.addEventListener('click', () => createItemRow());
    
    clearItemsBtn.addEventListener('click', () => {
      if (confirm('Clear all items?')) {
        itemsBody.innerHTML = '';
        updatePreview();
      }
    });
    
    // Sample items
    const sampleItems = [
      { description: "Lawn Maintenance (Monthly Plan)", quantity: 2, rate: 1500 },
      { description: "Outdoor Plant Supply", quantity: 5, rate: 500 },
      { description: "Garden Lighting Installation", quantity: 1, rate: 2500 }
    ];
    sampleItems.forEach(it => createItemRow(it));
    
    // Build invoice object
    function buildInvoiceObject() {
      const items = Array.from(itemsBody.children).map(r => {
        const desc = r.querySelector('.desc').value.trim();
        const qty = Number(r.querySelector('.qty').value || 0);
        const rate = Number(r.querySelector('.rate').value || 0);
        const amount = Number((rate * qty).toFixed(2));
        return { description: desc, quantity: qty, rate: rate, amount };
      });
      
      const subtotal = items.reduce((s, it) => s + it.amount, 0);
      
      const inv = {
        companies: { name: supplierNameInput.value.trim() },
        id: generateId(),
        invoice_number: invoiceNoInput.value || `INV-${Math.floor(Math.random()*9000)+1000}`,
        company_id: companyIdInput.value || '',
        company_address: supplierAddressInput.value || '',
        company_phone: supplierPhoneInput.value || '',
        company_email: supplierEmailInput.value || '',
        company_website: supplierWebsiteInput.value || '',
        amount: subtotal,
        items,
        status: statusInput.value,
        pdf_url: '',
        email_sent: false,
        created_at: createdAtInput.value ? new Date(createdAtInput.value).toISOString() : new Date().toISOString(),
        updated_at: new Date().toISOString(),
        client: {
          name: clientNameInput.value || '',
          address: clientAddressInput.value || '',
          phone: clientPhoneInput.value || '',
          email: clientEmailInput.value || ''
        },
        notes: notesInput.value || '',
        signatory: supplierSignInput.value || '',
        logo: currentLogoData
      };
      
      return inv;
    }
    
    // Update preview
    function updatePreview() {
      const inv = buildInvoiceObject();
      
      previewInvoiceNo.textContent = inv.invoice_number;
      previewDate.textContent = (new Date(inv.created_at)).toLocaleDateString();
      previewStatus.textContent = inv.status.toUpperCase();
      
      supplierNameEl.textContent = inv.companies?.name || '';
      supplierAddressEl.textContent = inv.company_address || '';
      supplierContactEl.innerHTML = `${inv.company_phone || ''}${inv.company_phone && inv.company_email ? ' ‚Ä¢ ' : ''}${inv.company_email || ''}`;
      
      supplierDetailsEl.innerHTML = escapeHtml(inv.companies?.name || '') + "<br>" +
                                    escapeHtml(inv.company_address || '') + "<br>" +
                                    escapeHtml(inv.company_phone || '') + "<br>" +
                                    escapeHtml(inv.company_email || '');
      
      if (inv.client && (inv.client.name || inv.client.address || inv.client.phone || inv.client.email)) {
        billToEl.innerHTML = `${escapeHtml(inv.client.name || '')}${inv.client.name ? '<br>' : ''}${escapeHtml(inv.client.address || '')}${inv.client.address ? '<br>' : ''}${escapeHtml(inv.client.phone || '')}${inv.client.phone ? '<br>' : ''}${escapeHtml(inv.client.email || '')}`;
      } else {
        billToEl.innerHTML = 'Client Name';
      }
      
      previewItemsBody.innerHTML = '';
      inv.items.forEach((it, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${escapeHtml(it.description)}</td>
          <td>‚Çπ${it.rate.toFixed(2)}</td>
          <td>${it.quantity}</td>
          <td class="right">‚Çπ${it.amount.toFixed(2)}</td>
        `;
        previewItemsBody.appendChild(tr);
      });
      
      previewSubtotal.textContent = `‚Çπ${inv.amount.toFixed(2)}`;
      previewTotal.textContent = `‚Çπ${inv.amount.toFixed(2)}`;
      previewNotesText.textContent = inv.notes || '';
      
      signCompanyEl.textContent = inv.companies?.name || '';
      signNameEl.textContent = inv.signatory || 'Authorized Signatory';
      
      displayLogo(inv.logo);
      generateQRCode();
    }
    
    // Save invoice
    saveBtn.addEventListener('click', () => {
      const inv = buildInvoiceObject();
      localStorage.setItem(INVOICE_KEY, JSON.stringify(inv));
      alert('‚úÖ Invoice saved successfully!');
    });
    
    // Load invoice
    loadBtn.addEventListener('click', () => {
      const raw = localStorage.getItem(INVOICE_KEY);
      if (!raw) { 
        alert('‚ùå No saved invoice found'); 
        return; 
      }
      try {
        const inv = JSON.parse(raw);
        importFromJSON(inv);
        alert('‚úÖ Invoice loaded successfully!');
      } catch (e) {
        alert('‚ùå Failed to load invoice');
      }
    });
    
    // Download JSON
    downloadJsonBtn.addEventListener('click', () => {
      const inv = buildInvoiceObject();
      const blob = new Blob([JSON.stringify(inv, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${inv.invoice_number || 'invoice'}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });
    
    // PDF generation
    pdfBtn.addEventListener('click', async () => {
      updatePreview();
      const element = document.getElementById('invoicePreview');
      const inv = buildInvoiceObject();
      
      const opt = {
        margin: 10,
        filename: `${inv.invoice_number || 'invoice'}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      
      html2pdf().set(opt).from(element).save();
    });
    
    previewBtn.addEventListener('click', updatePreview);
    
    // Auto-save supplier on input
    let saveSupplierTimeout;
    [supplierNameInput, supplierAddressInput, supplierPhoneInput, supplierEmailInput, supplierWebsiteInput, supplierSignInput].forEach(el => {
      el.addEventListener('input', () => {
        clearTimeout(saveSupplierTimeout);
        saveSupplierTimeout = setTimeout(() => {
          const s = getSupplierData();
          localStorage.setItem(SUPPLIER_KEY, JSON.stringify(s));
        }, 1000);
        updatePreview();
      });
    });
    
    // Auto-update preview on client input
    [clientNameInput, clientAddressInput, clientPhoneInput, clientEmailInput].forEach(el => {
      el.addEventListener('input', updatePreview);
    });
    
    // Auto-update on invoice details change
    [invoiceNoInput, companyIdInput, createdAtInput, statusInput, notesInput].forEach(el => {
      el.addEventListener('input', updatePreview);
      el.addEventListener('change', updatePreview);
    });
    
    // Helper functions
    function generateId() {
      return 'id_' + Math.random().toString(36).substring(2,9);
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }
    
    // Initialize
    loadSupplier();
    updatePreview();
  </script>
</body>
</html>